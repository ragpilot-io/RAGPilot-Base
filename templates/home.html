{% extends "base.html" %}
{% load static %}

{% block body_class %}h-screen bg-gray-100 overflow-hidden{% endblock %}

<style>
    /* ç¢ºä¿æ‰‹æ©Ÿç‰ˆ sidebar åº•éƒ¨æŒ‰éˆ•å¯è¦‹ */
    @media (max-width: 767px) {
        #sidebar {
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem) !important;
        }
        
        /* ç‚º iOS Safari æä¾›é¡å¤–çš„åº•éƒ¨é–“è· */
        @supports (-webkit-touch-callout: none) {
            #sidebar .border-t {
                padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 4rem) !important;
                margin-bottom: 1rem;
            }
        }
        
        /* ç¢ºä¿ç™»å‡ºæŒ‰éˆ•å®Œå…¨å¯è¦‹ */
        #sidebar .flex.flex-col.space-y-3 {
            margin-bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem);
        }
    }
    
    /* ç¢ºä¿å…§å®¹ä¸æœƒè¶…å‡ºè¦–çª— */
    #sidebar {
        contain: layout style;
    }
    
    /* ç‚ºæ‰‹æ©Ÿç‰ˆæ·»åŠ é¡å¤–çš„åº•éƒ¨ç©ºé–“ */
    @media (max-width: 767px) {
        #sidebar {
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 3rem) !important;
        }
        
        /* ç¢ºä¿ç”¨æˆ¶æ“ä½œå€åŸŸæœ‰è¶³å¤ çš„ç©ºé–“ */
        #sidebar .border-t {
            background-color: white;
            position: relative;
        }
        
        /* ç‚ºç™»å‡ºæŒ‰éˆ•æ·»åŠ é¡å¤–çš„é‚Šè· */
        #sidebar .border-t .flex.flex-col.space-y-3 > a:last-child {
            margin-bottom: calc(env(safe-area-inset-bottom, 1rem) + 1rem) !important;
        }
    }
</style>

{% block content %}

<!-- éš±è—çš„ CSRF token è¡¨å–®ï¼Œä¾› JavaScript ä½¿ç”¨ -->
<form style="display: none;">
    {% csrf_token %}
</form>

<div class="flex h-full">
    <!-- å·¦å´å´æ¬„ -->
    <!-- å´æ¬„æ”¶åˆæŒ‰éˆ•ï¼šå‚ç›´ç½®ä¸­ï¼Œä½æ–¼å´æ¬„å³ç·£ -->
    <button id="sidebar-toggle" class="btn btn-sm btn-circle fixed top-1/2 left-0 transform -translate-y-1/2 -translate-x-1/2 z-50 bg-white border border-gray-300 text-gray-700 shadow">
        â®
    </button>
    <aside id="sidebar" class="w-64 md:w-64 sm:w-56 h-full bg-white shadow-md p-4 md:p-6 overflow-hidden flex flex-col transition-all duration-300 transform" style="height: 100vh; height: 100dvh; max-height: 100dvh;">
        <div class="flex-1 overflow-y-auto" style="padding-bottom: 1rem;">
            <a href="{% url 'home' %}" class="block mb-4 md:mb-6">
                <img src="{% static 'sidebar_logo.png' %}" alt="æ•¸æ“šé ˜èˆªå“¡ RAGPilot" class="max-h-10 md:max-h-12 w-auto">
            </a>
            
            <!-- æ°´å¹³åˆ†éš”ç·š -->
            <div class="border-b border-gray-200 mb-4 md:mb-6"></div>

            {% if request_path != '/' %}
            <!-- åŠŸèƒ½æ¨¡å¼é¸æ“‡å€åŸŸ -->
            <div class="mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 border border-blue-100">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full mr-2">æ¨¡å¼</span>
                        é¸æ“‡ä½ çš„å·¥ä½œæ–¹å¼
                    </h3>
                    
                    <div class="space-y-2">
                        <!-- è³‡æ–™æŸ¥è©¢æ¨¡å¼ -->
                        <button id="data-query-tab" class="w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-white shadow-sm border-2 border-blue-200 hover:shadow-md group">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 mr-3 group-hover:bg-blue-200 transition-colors">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                                </svg>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-sm font-medium text-gray-900">è³‡æ–™æŸ¥è©¢</div>
                                <div class="text-xs text-gray-500">ç€è¦½å’Œæœå°‹çµæ§‹åŒ–è³‡æ–™</div>
                            </div>
                            <div class="w-4 h-4 rounded-full bg-blue-500 opacity-100" id="data-query-indicator"></div>
                        </button>
                        
                        <!-- æ·±åº¦ç ”ç©¶æ¨¡å¼ -->
                        <button id="deep-research-tab" class="w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 hover:border-gray-300 group">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 mr-3 group-hover:bg-purple-200 transition-colors">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-sm font-medium text-gray-900">æ·±åº¦ç ”ç©¶</div>
                                <div class="text-xs text-gray-500">è‡ªå®šç¾©ç ”ç©¶åŠåˆ†æä»»å‹™</div>
                            </div>
                            <div class="w-4 h-4 rounded-full bg-gray-300 opacity-0" id="deep-research-indicator"></div>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- è³‡æ–™æºåˆ—è¡¨å€åŸŸ -->
            <div class="mb-4">
                <a href="{% url 'source_create' %}" class="btn btn-primary btn-sm w-full mb-3">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    æ–°å¢è³‡æ–™æº
                </a>
                <div id="sidebar-sources-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- è³‡æ–™æºåˆ—è¡¨å°‡ç”± JavaScript è¼‰å…¥ -->
                    <div class="text-center py-4">
                        <div class="loading loading-spinner loading-sm"></div>
                        <p class="text-xs text-gray-500 mt-2">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                {% block source-description %}{% endblock %}
            </div>

            <!-- åŸå§‹ç¶²ç«™ -->
            {% if request_path != '/' and '/sources/' not in request_path %}
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <p class="text-sm font-semibold text-blue-800 mb-2">ğŸŒ åŸå§‹ç¶²ç«™</p>
                    {% if '/sources/' in request_path %}
                        <p class="text-xs text-gray-600">æ‚¨çš„è‡ªå»ºè³‡æ–™æº</p>
                    {% endif %}
                </div>
            {% endif %}


        </div>

        <!-- ç”¨æˆ¶æ“ä½œå€åŸŸ -->
        <div class="border-t pt-4 mt-4 flex-shrink-0" style="padding-bottom: calc(env(safe-area-inset-bottom, 1rem) + 2rem); min-height: fit-content;">
            <!-- çµ±ä¸€å‚ç›´ä½ˆå±€ - é©ç”¨æ–¼æ‰€æœ‰è¨­å‚™ -->
            <div class="flex flex-col space-y-3">
                <!-- ç”¨æˆ¶è³‡è¨ŠæŒ‰éˆ• - å…¨å¯¬åº¦ -->
                <a href="{% url 'profile' %}" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors w-full border border-gray-200 hover:border-gray-300">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium mr-3 flex-shrink-0" style="background-color: #3b82f6;">
                        {{ user.username|first|upper }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">{{ user.username }}</p>
                        <p class="text-xs text-gray-500">é»æ“ŠæŸ¥çœ‹å€‹äººè³‡æ–™</p>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </a>
                
                <!-- ç™»å‡ºæŒ‰éˆ• - å…¨å¯¬åº¦ -->
                <a href="{% url 'logout' %}" class="flex items-center justify-center p-3 rounded-lg text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors w-full border border-red-200 hover:border-red-300">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="font-medium">ç™»å‡º</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 p-6 h-full flex flex-col overflow-hidden">
        {% if request_path == '/' %}
            <!-- é¦–é æ­¡è¿å…§å®¹ -->
            <div class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="mb-8">
                        <h1 class="text-4xl font-bold text-gray-800 mb-4">æ•¸æ“šé ˜èˆªå“¡ RAGPilot</h1>
                        <p class="text-xl text-gray-600 mb-8">æ‚¨çš„è³‡æ–™æ¢ç´¢èˆ‡åˆ†æåŠ©æ‰‹</p>
                    </div>
                    
                    <div class="mt-8 text-sm text-gray-500">
                        <p>è«‹å¾å·¦å´é¸æ“‡è³‡æ–™æºé–‹å§‹æ‚¨çš„è³‡æ–™æ¢ç´¢ä¹‹æ—…</p>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- å…¶ä»–é é¢ï¼šå°è©±åŠŸèƒ½ + è³‡æ–™å€åŸŸ -->
            <div id="main-container" class="flex h-full space-x-6">
                <!-- å·¦å´ï¼šå°è©±å€åŸŸ -->
                <div id="chat-area" class="w-1/2 md:w-1/2 flex flex-col transition-all duration-300 relative z-[30]">
                    {% block chat_widget %}
                        {% include 'chat_widget.html' %}
                    {% endblock %}
                </div>
                
                <!-- å·¦å´ï¼šæ·±åº¦ç ”ç©¶å€åŸŸ -->
                <div id="research-area" class="w-1/2 md:w-1/2 flex flex-col transition-all duration-300 relative z-[30] hidden">
                    {% block research_widget %}
                        {% include 'deep_research_widget.html' %}
                    {% endblock %}
                </div>
                
                <!-- è³‡æ–™å€åŸŸæ”¶åˆæŒ‰éˆ•ï¼šæ‰‹æ©Ÿç‰ˆå°ˆç”¨ -->
                <button id="data-toggle" class="btn btn-sm btn-circle fixed top-1/2 right-0 transform -translate-y-1/2 translate-x-3 z-50 bg-white border border-gray-300 text-gray-700 shadow-lg hover:shadow-xl md:hidden">
                    â®
                </button>
                
                <!-- å³å´ï¼šè³‡æ–™å€åŸŸ -->
                <div id="data-area" class="w-1/2 md:w-1/2 flex flex-col overflow-hidden transition-all duration-300 md:translate-x-0">
                    <!-- é é¢æ¨™é¡Œ -->
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <div class="text-2xl font-bold">{% block source-name %}{% endblock %}</div>
                        <!-- è³‡æ–™å€åŸŸé—œé–‰æŒ‰éˆ•ï¼šæ‰‹æ©Ÿç‰ˆå°ˆç”¨ -->
                        <button id="data-close" class="btn btn-sm btn-circle md:hidden text-gray-500 hover:text-gray-700">
                            âœ•
                        </button>
                    </div>

                    <!-- éæ¿¾å™¨å€åŸŸ -->
                    <div class="flex-shrink-0">
                        <!-- éæ¿¾å™¨æ”¶åˆæŒ‰éˆ•ï¼šæ‰‹æ©Ÿç‰ˆé¡¯ç¤º -->
                        <div class="md:hidden mb-4">
                            <button id="filter-toggle" class="btn btn-sm btn-outline w-full justify-between">
                                <span id="filter-toggle-text">é¡¯ç¤ºç¯©é¸æ¢ä»¶</span>
                                <svg id="filter-toggle-icon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- éæ¿¾å™¨å…§å®¹å€åŸŸ -->
                        <div id="filter-content" class="hidden md:block">
                            {% block filter_section %}
                                <div class="flex space-x-2 mb-4">
                                    <label>
                                        <input type="text" placeholder="éæ¿¾å™¨" class="input input-bordered w-64"/>
                                    </label>
                                    <button class="btn btn-primary">æœå°‹</button>
                                </div>
                            {% endblock %}
                        </div>
                    </div>

                    <!-- è³‡æ–™è¡¨æ ¼å€åŸŸ -->
                    <div class="flex-1 min-h-0">
                        <div id="data-container" class="bg-white rounded-lg shadow p-4 h-full flex flex-col">
                            <div class="flex-1 min-h-0 overflow-hidden">
                                {% block data-table %}{% endblock %}
                            </div>
                            
                            <!-- åˆ†é å€åŸŸ -->
                            {% if is_paginated %}
                                <div id="pagination-container" class="flex justify-center mt-4 pt-4 border-t border-gray-200">
                                    <div class="join">
                                        {% if page_obj.has_previous %}
                                            <button data-page="{{ page_obj.previous_page_number }}" class="join-item btn pagination-btn" title="ä¸Šä¸€é ">&lt;</button>
                                        {% else %}
                                            <span class="join-item btn btn-disabled">&lt;</span>
                                        {% endif %}

                                        {% for i in page_obj.paginator.page_range|slice:":4" %}
                                            {% if i == page_obj.number %}
                                                <span class="join-item btn btn-active">{{ i }}</span>
                                            {% else %}
                                                <button data-page="{{ i }}" class="join-item btn pagination-btn">{{ i }}</button>
                                            {% endif %}
                                        {% endfor %}

                                        {% if page_obj.has_next %}
                                            <button data-page="{{ page_obj.next_page_number }}" class="join-item btn pagination-btn" title="ä¸‹ä¸€é ">&gt;</button>
                                        {% else %}
                                            <span class="join-item btn btn-disabled">&gt;</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleText(id, field, button) {
        const preview = document.getElementById(field + '-preview-' + id);
        const full = document.getElementById(field + '-full-' + id);

        if (preview.style.display === 'none') {
            preview.style.display = 'inline';
            full.style.display = 'none';
            button.innerText = 'å±•é–‹';
        } else {
            preview.style.display = 'none';
            full.style.display = 'inline';
            button.innerText = 'æ”¶åˆ';
        }
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent || element.innerText;
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(function() {
                showCopySuccess();
            }).catch(function(err) {
                console.error('è¤‡è£½å¤±æ•—: ', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess();
            } else {
                showCopyError();
            }
        } catch (err) {
            console.error('é™ç´šè¤‡è£½æ–¹æ¡ˆå¤±æ•—: ', err);
            showCopyError();
        }

        document.body.removeChild(textArea);
    }

    function showCopySuccess() {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = 'âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼';
        document.body.appendChild(toast);

        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }

    function showCopyError() {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½';
        document.body.appendChild(toast);

        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }

    const sourceSelect = document.getElementById('source-select');
    if (sourceSelect) {
        sourceSelect.addEventListener('change', function () {
            if (this.value) {
                window.location.href = this.value;
            }
        });
    }

    // æ¨¡å¼åˆ‡æ›åŠŸèƒ½
    const dataQueryTab = document.getElementById('data-query-tab');
    const deepResearchTab = document.getElementById('deep-research-tab');
    const chatArea = document.getElementById('chat-area');
    const researchArea = document.getElementById('research-area');
    const dataArea = document.getElementById('data-area');
    const dataQueryIndicator = document.getElementById('data-query-indicator');
    const deepResearchIndicator = document.getElementById('deep-research-indicator');
    
    function switchToDataQuery() {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        dataQueryTab.className = 'w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-white shadow-sm border-2 border-blue-200 hover:shadow-md group';
        deepResearchTab.className = 'w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 hover:border-gray-300 group';
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        dataQueryIndicator.className = 'w-4 h-4 rounded-full bg-blue-500 opacity-100';
        deepResearchIndicator.className = 'w-4 h-4 rounded-full bg-gray-300 opacity-0';
        
        // æ›´æ–°ä¸»è¦å…§å®¹å€åŸŸ
        chatArea.classList.remove('hidden');
        researchArea.classList.add('hidden');
        if (dataArea) dataArea.classList.remove('hidden');
    }
    
    function switchToDeepResearch() {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        dataQueryTab.className = 'w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 hover:border-gray-300 group';
        deepResearchTab.className = 'w-full flex items-center p-3 rounded-lg transition-all duration-200 bg-white shadow-sm border-2 border-purple-200 hover:shadow-md group';
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        dataQueryIndicator.className = 'w-4 h-4 rounded-full bg-gray-300 opacity-0';
        deepResearchIndicator.className = 'w-4 h-4 rounded-full bg-purple-500 opacity-100';
        
        // ç›´æ¥åˆ‡æ›å°è©±å€å¡Š
        chatArea.classList.add('hidden');
        researchArea.classList.remove('hidden');
        if (dataArea) dataArea.classList.remove('hidden');
    }
    
    if (dataQueryTab && deepResearchTab) {
        dataQueryTab.addEventListener('click', switchToDataQuery);
        deepResearchTab.addEventListener('click', switchToDeepResearch);
    }

    // AJAX åˆ†é åŠŸèƒ½
    function loadPage(pageNumber) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('page', pageNumber);
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const dataContainer = document.getElementById('data-container');
        if (dataContainer) {
            dataContainer.style.opacity = '0.6';
            dataContainer.style.pointerEvents = 'none';
        }
        
        fetch(currentUrl.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // å‰µå»ºè‡¨æ™‚ DOM ä¾†è§£æå›æ‡‰
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // æå–æ–°çš„è³‡æ–™è¡¨æ ¼å…§å®¹
            const newDataContainer = tempDiv.querySelector('#data-container');
            if (newDataContainer && dataContainer) {
                dataContainer.innerHTML = newDataContainer.innerHTML;
                
                // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
                bindToggleButtons();
                bindPaginationButtons();
                
                // æ›´æ–° URL ä½†ä¸é‡æ–°è¼‰å…¥é é¢
                window.history.pushState({}, '', currentUrl.toString());
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥é é¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            // å¦‚æœ AJAX å¤±æ•—ï¼Œå›é€€åˆ°å‚³çµ±é é¢è¼‰å…¥
            window.location.href = currentUrl.toString();
        })
        .finally(() => {
            // æ¢å¾©æ­£å¸¸ç‹€æ…‹
            if (dataContainer) {
                dataContainer.style.opacity = '1';
                dataContainer.style.pointerEvents = 'auto';
            }
        });
    }

    function bindToggleButtons() {
        const buttons = document.querySelectorAll('.toggle-button');
        buttons.forEach(function (button) {
            button.addEventListener('click', function () {
                const id = this.getAttribute('data-id');
                const field = this.getAttribute('data-field');
                toggleText(id, field, this);
            });
        });
    }

    function bindPaginationButtons() {
        const paginationButtons = document.querySelectorAll('.pagination-btn');
        paginationButtons.forEach(function (button) {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const pageNumber = this.getAttribute('data-page');
                if (pageNumber) {
                    loadPage(pageNumber);
                }
            });
        });
    }

    function bindFilterForm() {
        const filterForm = document.getElementById('filter-form');
        const clearBtn = document.getElementById('clear-btn');
        
        if (filterForm) {
            filterForm.addEventListener('submit', function (e) {
                e.preventDefault();
                
                // ç²å–æœå°‹æŒ‰éˆ•ä¸¦æ·»åŠ è¼‰å…¥ç‹€æ…‹
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                }
                
                // ç²å–è¡¨å–®æ•¸æ“š
                const formData = new FormData(filterForm);
                const params = new URLSearchParams(formData);
                
                // æ§‹å»ºæ–°çš„ URL
                const currentUrl = new URL(window.location);
                currentUrl.search = params.toString();
                
                // è¼‰å…¥éæ¿¾å¾Œçš„è³‡æ–™
                loadFilteredData(currentUrl.toString());
            });
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', function (e) {
                e.preventDefault();
                
                // æ¸…é™¤è¡¨å–®
                if (filterForm) {
                    filterForm.reset();
                }
                
                // è¼‰å…¥æœªéæ¿¾çš„è³‡æ–™
                const baseUrl = new URL(window.location);
                baseUrl.search = '';
                loadFilteredData(baseUrl.toString());
            });
        }
    }

    function loadFilteredData(url) {
        const dataContainer = document.getElementById('data-container');
        const filterForm = document.getElementById('filter-form');
        const submitBtn = filterForm ? filterForm.querySelector('button[type="submit"]') : null;
        
        if (dataContainer) {
            dataContainer.style.opacity = '0.6';
            dataContainer.style.pointerEvents = 'none';
        }
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // æ›´æ–°è³‡æ–™å®¹å™¨
            const newDataContainer = tempDiv.querySelector('#data-container');
            if (newDataContainer && dataContainer) {
                dataContainer.innerHTML = newDataContainer.innerHTML;
                
                // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
                bindToggleButtons();
                bindPaginationButtons();
                bindFilterToggle();
                
                // æ›´æ–° URL
                window.history.pushState({}, '', url);
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥éæ¿¾è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            window.location.href = url;
        })
        .finally(() => {
            // æ¢å¾©è³‡æ–™å®¹å™¨ç‹€æ…‹
            if (dataContainer) {
                dataContainer.style.opacity = '1';
                dataContainer.style.pointerEvents = 'auto';
            }
            
            // ç§»é™¤æœå°‹æŒ‰éˆ•çš„è¼‰å…¥ç‹€æ…‹
            if (submitBtn) {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        });
    }

    // éæ¿¾å™¨æ”¶åˆåŠŸèƒ½
    function bindFilterToggle() {
        const filterToggle = document.getElementById('filter-toggle');
        const filterContent = document.getElementById('filter-content');
        const filterToggleText = document.getElementById('filter-toggle-text');
        const filterToggleIcon = document.getElementById('filter-toggle-icon');
        
        if (filterToggle && filterContent && filterToggleText && filterToggleIcon) {
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•éæ¿¾æ¢ä»¶è¢«è¨­å®š
            function hasActiveFilters() {
                const filterForm = document.getElementById('filter-form');
                if (!filterForm) return false;
                
                const formData = new FormData(filterForm);
                for (const [key, value] of formData.entries()) {
                    if (value && value.trim() !== '') {
                        return true;
                    }
                }
                return false;
            }
            
            // åˆå§‹åŒ–éæ¿¾å™¨ç‹€æ…‹
            function initFilterState() {
                if (window.innerWidth < 768) { // æ‰‹æ©Ÿç‰ˆ
                    if (hasActiveFilters()) {
                        // æœ‰ç¯©é¸æ¢ä»¶æ™‚é è¨­å±•é–‹
                        filterContent.classList.remove('hidden');
                        filterToggleText.textContent = 'éš±è—ç¯©é¸æ¢ä»¶';
                        filterToggleIcon.style.transform = 'rotate(180deg)';
                    } else {
                        // æ²’æœ‰ç¯©é¸æ¢ä»¶æ™‚é è¨­æ”¶åˆ
                        filterContent.classList.add('hidden');
                        filterToggleText.textContent = 'é¡¯ç¤ºç¯©é¸æ¢ä»¶';
                        filterToggleIcon.style.transform = 'rotate(0deg)';
                    }
                } else {
                    // æ¡Œé¢ç‰ˆå§‹çµ‚é¡¯ç¤º
                    filterContent.classList.remove('hidden');
                }
            }
            
            // åˆ‡æ›éæ¿¾å™¨é¡¯ç¤ºç‹€æ…‹
            filterToggle.addEventListener('click', function() {
                const isHidden = filterContent.classList.contains('hidden');
                
                if (isHidden) {
                    // å±•é–‹éæ¿¾å™¨
                    filterContent.classList.remove('hidden');
                    filterToggleText.textContent = 'éš±è—ç¯©é¸æ¢ä»¶';
                    filterToggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    // æ”¶åˆéæ¿¾å™¨
                    filterContent.classList.add('hidden');
                    filterToggleText.textContent = 'é¡¯ç¤ºç¯©é¸æ¢ä»¶';
                    filterToggleIcon.style.transform = 'rotate(0deg)';
                }
            });
            
            // ç›£è½è¢å¹•å°ºå¯¸è®ŠåŒ–
            window.addEventListener('resize', function() {
                initFilterState();
            });
            
            // åˆå§‹åŒ–ç‹€æ…‹
            initFilterState();
        }
    }

    // å…¨ç«™å…¬å‘Šç›¸é—œåŠŸèƒ½
    let currentAnnouncement = null;

    function loadLatestAnnouncement() {
        fetch('/websites/announcement/latest/')
            .then(response => response.json())
            .then(data => {
                if (data.has_announcement) {
                    currentAnnouncement = data.announcement;
                    showAnnouncementBlock(data.announcement);
                } else {
                    hideAnnouncementBlock();
                }
            })
            .catch(error => {
                console.error('è¼‰å…¥å…¬å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                hideAnnouncementBlock();
            });
    }

    function showAnnouncementBlock(announcement) {
        const block = document.getElementById('announcement-block');
        const label = document.getElementById('announcement-label');
        const icon = document.getElementById('announcement-icon');
        const link = document.getElementById('announcement-link');

        if (block) {
            // æ ¹æ“šé‡è¦æ€§èª¿æ•´æ¨£å¼
            if (announcement.is_important) {
                block.className = 'mt-4 p-3 bg-red-100 border-2 border-red-300 rounded animate-pulse';
                label.textContent = 'ã€é‡è¦ã€‘å…¨ç«™å…¬å‘Š';
                icon.textContent = 'ğŸš¨';
            } else {
                block.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded';
                label.textContent = 'å…¨ç«™å…¬å‘Š';
                icon.textContent = 'ğŸ“¢';
            }

            // æ›´æ–°é€£çµæ–‡å­—
            if (link) {
                link.textContent = 'æŸ¥çœ‹ï¼š' + announcement.title + ' â†—';
            }

            block.style.display = 'block';
        }
    }

    function hideAnnouncementBlock() {
        const block = document.getElementById('announcement-block');
        if (block) {
            block.style.display = 'none';
        }
    }

    function openAnnouncementModal() {
        if (!currentAnnouncement) {
            alert('ç„¡æ³•è¼‰å…¥å…¬å‘Šå…§å®¹');
            return;
        }

        // å‰µå»ºæ¨¡æ…‹æ¡†
        const modal = document.createElement('div');
        modal.id = 'announcement-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">
                            ${currentAnnouncement.is_important ? 'ğŸš¨ ã€é‡è¦ã€‘' : 'ğŸ“¢'} ${currentAnnouncement.title}
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">
                            ç™¼å¸ƒè€…ï¼š${currentAnnouncement.created_by} â€¢ 
                            ç™¼å¸ƒæ™‚é–“ï¼š${new Date(currentAnnouncement.created_at).toLocaleString('zh-TW')}
                        </p>
                    </div>
                    <button onclick="closeAnnouncementModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto flex-1">
                    <div id="announcement-content" class="prose max-w-none">
                        ${marked ? marked.parse(currentAnnouncement.content) : currentAnnouncement.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
                
                <div class="flex justify-end p-6 border-t border-gray-200">
                    <button onclick="closeAnnouncementModal()" class="btn btn-primary">
                        é—œé–‰
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // é»æ“ŠèƒŒæ™¯é—œé–‰æ¨¡æ…‹æ¡†
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeAnnouncementModal();
            }
        });

        // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAnnouncementModal();
            }
        });
    }

    function closeAnnouncementModal() {
        const modal = document.getElementById('announcement-modal');
        if (modal) {
            modal.remove();
        }
    }

    // å´é‚Šæ¬„è³‡æ–™æºåˆ—è¡¨è¼‰å…¥åŠŸèƒ½
    function loadSidebarSources() {
        const sidebarSourcesList = document.getElementById('sidebar-sources-list');
        if (!sidebarSourcesList) return;

        fetch('/sources/list/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // æå–è³‡æ–™æºåˆ—è¡¨å…§å®¹
            const dataTable = tempDiv.querySelector('.data-table');
            if (dataTable) {
                const sources = dataTable.querySelectorAll('.card');
                let sidebarHtml = '';
                
                // ç²å–ç•¶å‰é é¢çš„è³‡æ–™æº ID
                const currentPath = window.location.pathname;
                const currentSourceId = currentPath.match(/\/sources\/(\d+)/)?.[1];
                
                sources.forEach(source => {
                    const sourceLink = source.querySelector('a[href*="/sources/"]');
                    if (sourceLink) {
                        const href = sourceLink.getAttribute('href');
                        const sourceId = href.match(/\/sources\/(\d+)/)?.[1];
                        const sourceName = source.querySelector('.text-purple-700')?.textContent || 'æœªçŸ¥è³‡æ–™æº';
                        const fileCount = source.querySelector('.badge-primary')?.textContent || '0 å€‹æª”æ¡ˆ';
                        const isActive = sourceId === currentSourceId;
                        
                        sidebarHtml += `
                            <a href="${href}" class="btn btn-ghost w-full justify-start py-3 h-auto min-h-[3.5rem] ${isActive ? 'btn-active bg-purple-100 text-purple-700' : 'text-left'}">
                                <div class="flex items-center w-full">
                                    <div class="text-purple-500 mr-3 text-lg">ğŸ“</div>
                                    <div class="flex-1 min-w-0 text-left">
                                        <div class="text-sm font-medium truncate leading-tight">${sourceName}</div>
                                        <div class="text-xs opacity-60 mt-1">${fileCount}</div>
                                    </div>
                                    ${isActive ? '<div class="w-2 h-2 bg-purple-500 rounded-full ml-2 flex-shrink-0"></div>' : ''}
                                </div>
                            </a>
                        `;
                    }
                });
                
                if (sidebarHtml) {
                    sidebarSourcesList.innerHTML = sidebarHtml;
                } else {
                    sidebarSourcesList.innerHTML = `
                        <div class="text-center py-6">
                            <div class="text-gray-400 text-4xl mb-3">ğŸ“</div>
                            <div class="text-sm text-gray-500 mb-4">é‚„æ²’æœ‰è³‡æ–™æº</div>
                            <a href="/sources/create/" class="btn btn-sm btn-primary w-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                å»ºç«‹ç¬¬ä¸€å€‹è³‡æ–™æº
                            </a>
                        </div>
                    `;
                }
            } else {
                sidebarSourcesList.innerHTML = '<div class="text-center py-2"><div class="text-xs text-gray-500">ç„¡æ³•è¼‰å…¥è³‡æ–™æºåˆ—è¡¨</div></div>';
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥å´é‚Šæ¬„è³‡æ–™æºåˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            sidebarSourcesList.innerHTML = '<div class="text-center py-2"><div class="text-xs text-red-500">è¼‰å…¥å¤±æ•—</div></div>';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        bindToggleButtons();
        bindPaginationButtons();
        bindFilterForm();
        bindFilterToggle(); // ç¶å®šéæ¿¾å™¨æ”¶åˆåŠŸèƒ½
        loadSidebarSources(); // è¼‰å…¥å´é‚Šæ¬„è³‡æ–™æºåˆ—è¡¨
        // å‰µå»º sidebar èƒŒæ™¯é®ç½©
        function createSidebarOverlay() {
            // é¿å…é‡è¤‡å‰µå»º
            if (document.getElementById('sidebar-overlay')) return;
            
            const overlay = document.createElement('div');
            overlay.id = 'sidebar-overlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
            overlay.style.display = 'none';
            
            overlay.addEventListener('click', function() {
                // é»æ“Šé®ç½©é—œé–‰ sidebar
                const sidebar = document.getElementById('sidebar');
                const sidebarToggle = document.getElementById('sidebar-toggle');
                if (sidebar && sidebarToggle) {
                    sidebar.classList.add('absolute', '-translate-x-full');
                    sidebar.classList.remove('fixed', 'inset-0');
                    sidebarToggle.textContent = 'â¯';
                    sidebarToggle.style.left = '0.5rem';
                    removeSidebarOverlay();
                }
            });
            
            document.body.appendChild(overlay);
            // å»¶é²é¡¯ç¤ºä»¥ç¢ºä¿ DOM æ›´æ–°
            setTimeout(() => {
                overlay.style.display = 'block';
            }, 10);
        }
        
        function removeSidebarOverlay() {
            const overlay = document.getElementById('sidebar-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // å´æ¬„æ”¶åˆåŠŸèƒ½
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        if (sidebarToggle && sidebar) {
            // åˆå§‹åŒ– sidebar ç‹€æ…‹
            function initSidebarState() {
                if (window.innerWidth < 768) { // æ‰‹æ©Ÿç‰ˆ
                    // æ‰‹æ©Ÿç‰ˆé è¨­æ”¶åˆ
                    sidebar.classList.add('absolute', '-translate-x-full');
                    sidebar.style.zIndex = '50'; // ç¢ºä¿åœ¨æœ€ä¸Šå±¤
                    sidebarToggle.textContent = 'â¯';
                    sidebarToggle.style.left = '0.5rem';
                    // ç¢ºä¿æ‰‹æ©Ÿç‰ˆçš„é«˜åº¦æ­£ç¢º
                    sidebar.style.height = '100vh';
                    sidebar.style.maxHeight = '100vh';
                } else {
                    // æ¡Œé¢ç‰ˆé è¨­å±•é–‹
                    sidebar.classList.remove('absolute', '-translate-x-full');
                    sidebar.style.zIndex = ''; // é‡ç½® z-index
                    sidebarToggle.textContent = 'â®';
                    sidebarToggle.style.left = sidebar.offsetWidth + 'px';
                    // æ¡Œé¢ç‰ˆé‡ç½®é«˜åº¦æ¨£å¼
                    sidebar.style.height = '';
                    sidebar.style.maxHeight = '';
                }
            }
            
            // åˆå§‹åŒ–ç‹€æ…‹
            initSidebarState();
            
            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener('resize', function() {
                // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ‰‹æ©Ÿç‰ˆç‰¹æ®Šæ¨£å¼
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('fixed');
                    sidebar.style.zIndex = '';
                    sidebar.style.top = '';
                    sidebar.style.left = '';
                    sidebar.style.height = '';
                    removeSidebarOverlay(); // ç§»é™¤é®ç½©
                }
                initSidebarState();
                // ç•¶åˆ‡æ›åˆ°æ¡Œé¢ç‰ˆæ™‚ï¼Œç¢ºä¿æŒ‰éˆ•é¡¯ç¤ºæ­£ç¢º
                if (window.innerWidth >= 768) {
                    sidebarToggle.style.display = 'block';
                }
            });

            sidebarToggle.addEventListener('click', function () {
                const isCollapsed = sidebar.classList.contains('absolute');

                if (isCollapsed) {
                    // å±•é–‹å´æ¬„
                    sidebar.classList.remove('absolute', '-translate-x-full');
                    if (window.innerWidth < 768) {
                        // æ‰‹æ©Ÿç‰ˆï¼šä½¿ç”¨å›ºå®šå®šä½ä½†ä¿æŒåŸä¾†çš„å¯¬åº¦
                        sidebar.style.zIndex = '50';
                        sidebar.classList.add('fixed');
                        sidebar.style.top = '0';
                        sidebar.style.left = '0';
                        sidebar.style.height = '100vh';
                        sidebar.style.height = '100dvh';
                        // å‰µå»ºèƒŒæ™¯é®ç½©
                        createSidebarOverlay();
                        
                        // ç¢ºä¿åº•éƒ¨å…§å®¹å¯è¦‹
                        const userArea = sidebar.querySelector('.border-t');
                        if (userArea) {
                            userArea.style.paddingBottom = 'calc(env(safe-area-inset-bottom, 1rem) + 3rem)';
                        }
                    }
                    this.textContent = 'â®';
                    this.style.left = sidebar.offsetWidth + 'px';
                } else {
                    // æ”¶åˆå´æ¬„ï¼šè¨­ç‚ºçµ•å°å®šä½ä¸¦ç§»å‡ºè¦–å£ï¼Œè®“ä¸»å…§å®¹è‡ªå‹•æ’æ»¿
                    sidebar.classList.add('absolute', '-translate-x-full');
                    if (window.innerWidth < 768) {
                        // æ‰‹æ©Ÿç‰ˆï¼šç§»é™¤å›ºå®šå®šä½
                        sidebar.classList.remove('fixed');
                        sidebar.style.top = '';
                        sidebar.style.left = '';
                        sidebar.style.height = '';
                        // ç§»é™¤èƒŒæ™¯é®ç½©
                        removeSidebarOverlay();
                        
                        // é‡ç½®åº•éƒ¨æ¨£å¼
                        const userArea = sidebar.querySelector('.border-t');
                        if (userArea) {
                            userArea.style.paddingBottom = '';
                        }
                    }
                    this.textContent = 'â¯';
                    this.style.left = '0.5rem';
                }
            });
        }

        // è³‡æ–™å€åŸŸæ”¶åˆåŠŸèƒ½ï¼ˆæ‰‹æ©Ÿç‰ˆå°ˆç”¨ï¼‰
        const dataToggle = document.getElementById('data-toggle');
        const dataClose = document.getElementById('data-close');
        const dataArea = document.getElementById('data-area');
        const chatArea = document.getElementById('chat-area');
        const mainContainer = document.getElementById('main-container');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle');
        
        if (dataToggle && dataArea && chatArea && dataClose && mainContainer && sidebarToggleBtn) {
            // åˆå§‹ç‹€æ…‹ï¼šåœ¨æ‰‹æ©Ÿç‰ˆæ™‚è³‡æ–™å€åŸŸæ˜¯éš±è—çš„
            function initDataAreaState() {
                if (window.innerWidth < 768) { // md breakpoint
                    // æ‰‹æ©Ÿç‰ˆï¼šé è¨­éš±è—è³‡æ–™å€åŸŸ
                    dataArea.classList.add('fixed', 'inset-0', 'z-40', 'translate-x-full', 'bg-white', 'p-6');
                    dataArea.classList.remove('w-1/2');
                    chatArea.classList.remove('w-1/2');
                    chatArea.classList.add('w-full');
                    mainContainer.classList.remove('space-x-6');
                    dataToggle.style.display = 'block';
                } else {
                    // æ¡Œé¢ç‰ˆï¼šæ¢å¾©åŸå§‹ä½ˆå±€
                    dataArea.classList.remove('fixed', 'inset-0', 'z-40', 'translate-x-full', 'bg-white', 'p-6');
                    dataArea.classList.add('w-1/2');
                    chatArea.classList.add('w-1/2');
                    chatArea.classList.remove('w-full');
                    mainContainer.classList.add('space-x-6');
                    dataToggle.style.display = 'none';
                }
            }

            // åˆ‡æ›è³‡æ–™å€åŸŸé¡¯ç¤ºç‹€æ…‹
            function toggleDataArea() {
                const isHidden = dataArea.classList.contains('translate-x-full');
                
                if (isHidden) {
                    // é¡¯ç¤ºè³‡æ–™å€åŸŸï¼šè¦†è“‹æ•´å€‹è¢å¹•
                    dataArea.classList.remove('translate-x-full');
                    dataArea.classList.add('translate-x-0');
                    // éš±è—å±•é–‹æŒ‰éˆ•ï¼Œå› ç‚ºç¾åœ¨å¯ä»¥ç”¨ X é—œé–‰
                    dataToggle.style.display = 'none';
                    // éš±è— sidebar çš„å±•é–‹/é—œé–‰æŒ‰éˆ•
                    sidebarToggleBtn.style.display = 'none';
                } else {
                    // éš±è—è³‡æ–™å€åŸŸ
                    dataArea.classList.add('translate-x-full');
                    dataArea.classList.remove('translate-x-0');
                    // é¡¯ç¤ºå±•é–‹æŒ‰éˆ•
                    dataToggle.style.display = 'block';
                    // æ¢å¾© sidebar çš„å±•é–‹/é—œé–‰æŒ‰éˆ•ï¼ˆåªåœ¨æ‰‹æ©Ÿç‰ˆï¼‰
                    if (window.innerWidth < 768) {
                        sidebarToggleBtn.style.display = 'block';
                    }
                }
            }

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            dataToggle.addEventListener('click', toggleDataArea);
            dataClose.addEventListener('click', function() {
                // é—œé–‰è³‡æ–™å€åŸŸ
                dataArea.classList.add('translate-x-full');
                dataArea.classList.remove('translate-x-0');
                // é¡¯ç¤ºå±•é–‹æŒ‰éˆ•
                dataToggle.style.display = 'block';
                // æ¢å¾© sidebar çš„å±•é–‹/é—œé–‰æŒ‰éˆ•ï¼ˆåªåœ¨æ‰‹æ©Ÿç‰ˆï¼‰
                if (window.innerWidth < 768) {
                    sidebarToggleBtn.style.display = 'block';
                }
            });

            // ç›£è½è¢å¹•å°ºå¯¸è®ŠåŒ–
            window.addEventListener('resize', function() {
                initDataAreaState();
                // ç¢ºä¿ sidebar æŒ‰éˆ•åœ¨æ­£ç¢ºçš„ç‹€æ…‹
                if (window.innerWidth >= 768) {
                    sidebarToggleBtn.style.display = 'block';
                }
            });
            
            // åˆå§‹åŒ–ç‹€æ…‹
            initDataAreaState();
        }
    });
</script>
{% endblock %}
