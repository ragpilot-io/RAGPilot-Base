{% extends 'home.html' %}

{% block source-name %}{% endblock %}

{% block source-description %}
<div class="p-3 bg-purple-50 border border-purple-200 rounded">
    <p class="text-sm font-semibold text-purple-800 mb-2">📁 自建資料源</p>
    <p class="text-xs text-purple-600 mb-2">
        建立和管理您的私有資料庫，上傳文件並進行智慧對話。
    </p>
    {% if not has_unlimited_source %}
        <div class="text-xs text-purple-700 bg-purple-100 rounded px-2 py-1">
            📊 已建立：{{ private_source_count }}/{{ private_source_limit }} 個資料源
        </div>
    {% else %}
        <div class="text-xs text-purple-700 bg-purple-100 rounded px-2 py-1">
            ✨ 無限制建立資料源
        </div>
    {% endif %}
</div>
{% endblock %}

{% block filter_section %}
    <!-- 操作按鈕區 -->
    <div class="flex flex-wrap gap-2 mb-4">
        {% if can_create_source %}
            <a href="{% url 'source_create' %}" class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                建立新資料源
            </a>
        {% else %}
            <button class="btn btn-primary btn-disabled" title="已達到資料源數量上限">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                建立新資料源 (已達上限)
            </button>
        {% endif %}
    </div>

    <!-- 限制警告 -->
    {% if not has_unlimited_source and private_source_count >= private_source_limit %}
        <div class="alert alert-warning mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.08 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <div>
                <h3 class="font-bold">已達到資料源數量上限</h3>
                <div class="text-xs">您已建立 {{ private_source_count }} 個資料源，已達到上限（{{ private_source_limit }} 個）。如需建立更多資料源，請刪除現有資料源或聯繫管理員。</div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block data-table %}
    <div class="data-table h-full overflow-y-auto pr-2 space-y-4">
        <!-- 顯示訊息 -->
        {% if messages %}
            <div class="mb-4 space-y-2">
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-error{% else %}alert-info{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if sources %}
            {% for source in sources %}
                <div class="card shadow-md bg-white p-4 border border-gray-200 hover:shadow-lg hover:border-purple-300 transition-all duration-200">
                    <div class="flex justify-between items-start">
                        <!-- 左側內容區域 -->
                        <div class="flex-1 space-y-2 text-sm text-gray-800 mr-4">
                            <div class="flex items-center">
                                <span class="font-semibold text-lg text-purple-700">{{ source.name }}</span>
                                <span class="badge badge-primary badge-sm ml-2">{{ source.file_count }} 個檔案</span>
                            </div>
                            <div><span class="font-semibold">描述：</span>{{ source.description }}</div>
                            <div><span class="font-semibold">建立時間：</span>{{ source.created_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        
                        <!-- 右側按鈕區域 -->
                        <div class="flex flex-col space-y-2 min-w-fit">
                            <a href="{% url 'source_detail' source.id %}" class="btn btn-sm btn-outline btn-primary">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                查看詳情
                            </a>
                            <button class="btn btn-sm btn-outline btn-success add-reference-btn"
                                    data-id="{{ source.id }}"
                                    data-name="{{ source.name }}"
                                    data-description="{{ source.description }}"
                                    data-file-count="{{ source.file_count }}"
                                    data-created-at="{{ source.created_at|date:'Y-m-d H:i' }}">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                加入對話
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="card shadow-md bg-white p-4 border border-gray-200">
                <div class="text-center space-y-4">
                    <div class="text-6xl text-gray-300">📁</div>
                    <div class="space-y-2">
                        <div class="text-gray-500 font-medium">還沒有任何自建資料源</div>
                        {% if can_create_source %}
                            <div class="text-sm text-gray-400">點擊上方「建立新資料源」按鈕開始建立您的第一個資料源</div>
                        {% else %}
                            <div class="text-sm text-red-500">您已達到資料源數量上限（{{ private_source_limit }} 個），無法建立新的資料源</div>
                        {% endif %}
                    </div>
                    {% if can_create_source %}
                        <div>
                            <a href="{% url 'source_create' %}" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                建立新資料源
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% endblock %} 