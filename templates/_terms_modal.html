<!-- 使用條款彈出視窗 -->
<div id="terms-modal" class="modal">
  <div class="modal-box w-11/12 max-w-4xl max-h-screen">
    <div class="flex justify-between items-center mb-4 sticky top-0 bg-base-100 z-10 pb-4 border-b">
      <h3 id="terms-title" class="font-bold text-xl">使用條款</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="closeTermsModal()">✕</button>
    </div>
    
    <div class="overflow-auto max-h-96">
      <!-- Loading 狀態 -->
      <div id="terms-loading" class="flex justify-center items-center py-8">
        <div class="loading loading-spinner loading-lg"></div>
        <span class="ml-2">載入條款內容中...</span>
      </div>
      
      <!-- 條款內容 -->
      <div id="terms-content" class="prose prose-sm max-w-none hidden">
        <!-- 動態載入的條款內容將插入這裡 -->
      </div>
      
      <!-- 錯誤訊息 -->
      <div id="terms-error" class="alert alert-error hidden">
        <span>載入條款內容失敗，請稍後再試。</span>
      </div>
    </div>
    
    <div class="modal-action">
      <div id="terms-actions" class="hidden">
        <button id="agree-btn" class="btn btn-primary" onclick="agreeToTerms()">
          <span class="loading loading-spinner loading-sm hidden" id="agree-loading"></span>
          同意並關閉
        </button>
        <button class="btn btn-ghost" onclick="closeTermsModal()">取消</button>
      </div>
      <div id="terms-view-only" class="hidden">
        <button class="btn btn-primary" onclick="closeTermsModal()">關閉</button>
      </div>
    </div>
  </div>
  <div class="modal-backdrop" onclick="handleBackdropClick()"></div>
</div>

<script>
// 處理背景點擊
function handleBackdropClick() {
  if (!isForced) {
    closeTermsModal();
  }
}

// 防止 ESC 鍵在強制模式下關閉彈窗
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && isForced) {
    const modal = document.getElementById('terms-modal');
    if (modal && modal.classList.contains('modal-open')) {
      event.preventDefault();
      alert('您必須同意使用條款才能繼續使用本服務');
    }
  }
});
</script>

<!-- Markdown 解析器 CDN -->
<script>
let isForced = false; // 是否為強制同意模式
let markedReady = false;
let markedLoadPromise = null;

// 全域錯誤處理器，防止條款相關錯誤導致頁面崩潰
window.addEventListener('error', function(event) {
  if (event.filename && event.filename.includes('marked')) {
    console.warn('Marked.js 相關錯誤，標記為載入失敗');
    window.markedLoadFailed = true;
    event.preventDefault(); // 防止錯誤傳播
  }
});

// 動態載入 Marked.js 並處理載入狀態
function loadMarkedJS() {
  if (markedLoadPromise) {
    return markedLoadPromise;
  }
  
  markedLoadPromise = new Promise((resolve, reject) => {
    // 檢查是否已經載入
    if (typeof marked !== 'undefined' && marked.parse) {
      markedReady = true;
      resolve(true);
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js';
    script.async = true;
    
    script.onload = function() {
      // 雙重檢查以確保 marked 真的可用
      setTimeout(() => {
        if (typeof marked !== 'undefined' && marked.parse) {
          console.log('Marked.js 載入成功');
          markedReady = true;
          resolve(true);
        } else {
          console.warn('Marked.js 載入後仍無法使用');
          window.markedLoadFailed = true;
          resolve(false);
        }
      }, 100);
    };
    
    script.onerror = function() {
      console.warn('Marked.js CDN 載入失敗，將使用 Markdown 原文顯示');
      window.markedLoadFailed = true;
      resolve(false);
    };
    
    // 設置超時機制
    setTimeout(() => {
      if (!markedReady && !window.markedLoadFailed) {
        console.warn('Marked.js 載入超時，使用 Markdown 原文顯示');
        window.markedLoadFailed = true;
        resolve(false);
      }
    }, 5000);
    
    document.head.appendChild(script);
  });
  
  return markedLoadPromise;
}

// 立即開始載入 Marked.js
loadMarkedJS();

// 檢查 Marked.js 是否真正可用
function isMarkedAvailable() {
  if (window.markedLoadFailed) {
    return false;
  }
  
  try {
    return markedReady && 
           typeof marked !== 'undefined' && 
           marked !== null && 
           typeof marked.parse === 'function';
  } catch (e) {
    console.warn('檢查 Marked.js 時發生錯誤:', e);
    window.markedLoadFailed = true;
    return false;
  }
}

// 安全地轉換 Markdown 內容（非同步版本）
async function safeMarkdownToHtml(content) {
  // 等待 Marked.js 載入完成
  try {
    await loadMarkedJS();
  } catch (e) {
    console.warn('等待 Marked.js 載入時發生錯誤:', e);
  }
  
  if (isMarkedAvailable()) {
    try {
      return marked.parse(content);
    } catch (e) {
      console.warn('Marked.js 解析失敗，使用 Markdown 原文顯示:', e);
    }
  }
  
  // 降級到顯示 Markdown 原文
  console.warn('使用 Markdown 原文顯示');
  return '<pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.5; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e9ecef;">' + 
         content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
}

async function openTermsModal(forced = false) {
  try {
    isForced = forced;
    const modal = document.getElementById('terms-modal');
    
    if (!modal) {
      console.error('找不到條款模態框元素');
      return;
    }
    
    // 重設狀態
    document.getElementById('terms-loading').classList.remove('hidden');
    document.getElementById('terms-content').classList.add('hidden');
    document.getElementById('terms-error').classList.add('hidden');
    document.getElementById('terms-actions').classList.add('hidden');
    document.getElementById('terms-view-only').classList.add('hidden');
    
    modal.classList.add('modal-open');
    
    // 載入條款內容
    await loadTermsContent(forced);
  } catch (error) {
    console.error('開啟條款模態框時發生錯誤:', error);
    try {
      showTermsError('開啟條款失敗，請重新整理頁面後再試');
    } catch (e) {
      alert('開啟條款失敗，請重新整理頁面後再試');
    }
  }
}

function closeTermsModal() {
  if (isForced) {
    // 如果是強制模式，不允許關閉
    alert('您必須同意使用條款才能繼續使用本服務');
    return;
  }
  
  const modal = document.getElementById('terms-modal');
  modal.classList.remove('modal-open');
  
  // 重置檢查標記，允許下次重新檢查
  console.log('條款模態框關閉，重置檢查標記');
  resetTermsCheckFlags();
}

// 重置條款檢查標記的函數
function resetTermsCheckFlags() {
  if (typeof termsCheckPerformed !== 'undefined') {
    termsCheckPerformed = false;
  }
  if (typeof forceTermsProcessed !== 'undefined') {
    forceTermsProcessed = false;
  }
}

function showTermsError(message) {
  try {
    document.getElementById('terms-loading').classList.add('hidden');
    document.getElementById('terms-content').classList.add('hidden');
    
    const errorElement = document.getElementById('terms-error');
    errorElement.querySelector('span').textContent = message || '載入條款內容失敗，請稍後再試。';
    errorElement.classList.remove('hidden');
    
    // 顯示關閉按鈕
    document.getElementById('terms-view-only').classList.remove('hidden');
  } catch (error) {
    console.error('顯示錯誤訊息失敗:', error);
    alert('系統發生錯誤，請重新整理頁面');
  }
}

async function loadTermsContent(forced = false) {
  try {
    // 添加時間戳參數避免快取
    const timestamp = new Date().getTime();
    const response = await fetch(`/websites/check-terms-status/?t=${timestamp}`);
    
    if (response.status === 403 || response.status === 401) {
      // 未登入用戶，顯示預設條款內容
      await showDefaultTermsForGuest();
      return;
    }
    
    const data = await response.json();
    if (!data) return; // 如果是未登入用戶，已經在上面處理了
    
    document.getElementById('terms-loading').classList.add('hidden');
    
    if (data.needs_agreement || !forced) {
      // 顯示條款內容
      const content = data.terms_content || '<p>目前尚無條款</p>';
      const title = data.terms_title || '使用條款';
      
      document.getElementById('terms-title').textContent = title;
      
      // 安全地轉換 Markdown 內容
      const htmlContent = await safeMarkdownToHtml(content);
      
      document.getElementById('terms-content').innerHTML = htmlContent;
      document.getElementById('terms-content').classList.remove('hidden');
      
      // 顯示適當的按鈕
      if (data.needs_agreement) {
        document.getElementById('terms-actions').classList.remove('hidden');
      } else {
        document.getElementById('terms-view-only').classList.remove('hidden');
      }
    } else {
      // 用戶已同意，直接關閉
      closeTermsModal();
    }
  } catch (error) {
    console.error('載入條款失敗:', error);
    // 如果是網路錯誤，顯示預設條款內容
    try {
      await showDefaultTermsForGuest();
    } catch (e) {
      console.error('顯示預設條款也失敗:', e);
      showTermsError('載入條款內容失敗，請重新整理頁面後再試');
    }
  }
}

async function showDefaultTermsForGuest() {
  try {
    document.getElementById('terms-loading').classList.add('hidden');
    
    // 顯示預設條款內容
    const content = '<p>目前尚無條款</p>';
    const title = '使用條款';
    
    document.getElementById('terms-title').textContent = title;
    
    // 安全地轉換 Markdown 內容
    const htmlContent = await safeMarkdownToHtml(content);
    
    document.getElementById('terms-content').innerHTML = htmlContent;
    document.getElementById('terms-content').classList.remove('hidden');
    
    // 對於未登入用戶，只顯示關閉按鈕
    document.getElementById('terms-view-only').classList.remove('hidden');
  } catch (error) {
    console.error('顯示條款內容時發生錯誤:', error);
    showTermsError('載入條款內容失敗');
  }
}

function agreeToTerms() {
  const agreeBtn = document.getElementById('agree-btn');
  const agreeLoading = document.getElementById('agree-loading');
  
  // 顯示載入狀態
  agreeBtn.disabled = true;
  agreeLoading.classList.remove('hidden');
  
  // 取得 CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                    document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
  
  fetch('/websites/agree-to-terms/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 同意成功
      const modal = document.getElementById('terms-modal');
      modal.classList.remove('modal-open');
      
      // 重置檢查標記
      console.log('條款同意成功，重置檢查標記');
      resetTermsCheckFlags();
      
      // 顯示成功訊息
      if (typeof showSuccessMessage === 'function') {
        showSuccessMessage('條款同意已記錄');
      }
      
      // 重新載入頁面或更新狀態
      if (isForced) {
        // 如果是強制模式，重新載入頁面
        window.location.reload();
      }
    } else {
      alert('同意失敗：' + data.message);
    }
  })
  .catch(error => {
    console.error('同意條款失敗:', error);
    alert('操作失敗，請稍後再試');
  })
  .finally(() => {
    // 恢復按鈕狀態
    agreeBtn.disabled = false;
    agreeLoading.classList.add('hidden');
  });
}



// 防止重複檢查的標記
let termsCheckPerformed = false;

// 頁面載入時檢查是否需要強制同意條款
document.addEventListener('DOMContentLoaded', function() {
  // 防止重複檢查
  if (termsCheckPerformed) {
    console.log('條款檢查已執行過，跳過重複檢查');
    return;
  }
  
  // 只在登入後的頁面檢查（排除登入、admin、靜態資源等頁面）
  if (!window.location.pathname.includes('/login/') &&
      !window.location.pathname.includes('/admin/') &&
      !window.location.pathname.includes('/accounts/') &&
      !window.location.pathname.includes('/static/') &&
      !window.location.pathname.includes('/websites/') &&
      window.location.pathname !== '/favicon.ico') {
    
    // 標記檢查已執行
    termsCheckPerformed = true;
    
    // 等待 Marked.js 載入完成後再檢查條款
    loadMarkedJS().then(() => {
      // 稍微延遲執行，確保頁面完全穩定
      setTimeout(() => {
        checkTermsAgreement();
      }, 300);
    }).catch(e => {
      console.warn('Marked.js 載入失敗，但仍繼續檢查條款:', e);
      setTimeout(() => {
        checkTermsAgreement();
      }, 300);
    });
  }
});

// 防止條款檢查函數重複執行的標記
let forceTermsProcessed = false;

function checkTermsAgreement() {
  try {
    // 檢查URL中是否有force_terms參數
    const urlParams = new URLSearchParams(window.location.search);
    const forceTerms = urlParams.get('force_terms');
    
    if (forceTerms === '1') {
      // 防止重複處理 force_terms
      if (forceTermsProcessed) {
        console.log('force_terms 已處理過，跳過重複處理');
        return;
      }
      forceTermsProcessed = true;
      
      // 強制彈出條款（來自 TermsRequiredMixin 重定向）
      console.log('檢測到 force_terms=1 參數，將彈出條款模態框');
      setTimeout(async () => {
        try {
          await openTermsModal(true);
          // 清除URL中的force_terms參數
          urlParams.delete('force_terms');
          const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
          window.history.replaceState({}, '', newUrl);
        } catch (e) {
          console.error('彈出條款模態框失敗:', e);
        }
      }, 500);
      return;
    }
    
    // 正常的條款檢查流程
    fetch('/websites/check-terms-status/')
      .then(response => {
        if (!response.ok) {
          if (response.status === 403 || response.status === 401) {
            // 未登入用戶，忽略條款檢查
            return;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data && data.needs_agreement) {
          // 需要同意條款，強制彈出
          setTimeout(async () => {
            try {
              await openTermsModal(true);
            } catch (e) {
              console.error('彈出條款模態框失敗:', e);
            }
          }, 1000); // 延遲1秒顯示，讓頁面完全載入
        }
      })
      .catch(error => {
        console.error('檢查條款狀態失敗:', error);
        // 不要因為檢查條款失敗而影響頁面正常使用
      });
  } catch (error) {
    console.error('條款檢查函數執行失敗:', error);
  }
}
</script> 